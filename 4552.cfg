global
	log /dev/log	local0
	log /dev/log	local1 notice
	chroot /var/lib/haproxy
	stats socket /run/haproxy/admin.sock mode 660 level admin
	stats timeout 30s
	user haproxy
	group haproxy
	daemon

	# Default SSL material locations
	ca-base /etc/ssl/certs
	crt-base /etc/ssl/private

	# Default ciphers to use on SSL-enabled listening sockets.
	# For more information, see ciphers(1SSL). This list is from:
	#  https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/
	ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256::RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS
	ssl-default-bind-options no-sslv3

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    timeout tunnel  3600s    # 웹소켓 유지용

frontend Local_Server
    bind :4552
    mode http

    # [기존 설정] /stats_api 로 시작하면 통계로 보냄
    acl url_stats path_beg /stats_api
    
    # ▼▼▼ [추가] /api/v1 으로 시작해도 통계로 보냄 ▼▼▼
    acl url_stats_v1 path_beg /api/v1
    
    # ▼▼▼ [수정] 둘 중 하나라도 맞으면 Stats_Backend로 보냄 ▼▼▼
    use_backend Stats_Backend if url_stats or url_stats_v1

    # 나머지는 전부 기본 웹서버(4000)로 보냄
    default_backend My_Web_Servers



backend My_Web_Servers
    mode http
    balance roundrobin
    option forwardfor
    
    # 웹소켓 설정 유지
    http-request set-header Connection "Upgrade" if { hdr(Upgrade) -i WebSocket }
    http-request set-header Upgrade "WebSocket" if { hdr(Upgrade) -i WebSocket }

    # ▼▼▼ [삭제 또는 주석 처리 (#)] ▼▼▼
    # 이 줄이 범인입니다. 주석 처리해주세요.
    # option httpchk HEAD / HTTP/1.1\r\nHost:localhost

    # ▼▼▼ [수정] 끝에 있던 'check' 단어를 지워주세요 ▼▼▼
    # 수정 전: server blockscout 127.0.0.1:4000 check
    # 수정 후: (무조건 연결 시도)
    server blockscout 127.0.0.1:4000


backend Stats_Backend
    mode http
    balance roundrobin
    option forwardfor

    # ▼▼▼ [수정] 뒤쪽의 '/'를 '/api/' 로 바꿔주세요 ▼▼▼
    http-request replace-path /stats_api(/)?(.*) /\2
    # 결과: /stats_api/v1/lines  --->  /api/v1/lines (서버가 알아들음! 정답!)
    server stats_server 127.0.0.1:8050
